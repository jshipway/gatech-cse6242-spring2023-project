<html>
<head>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="globals.js"></script>
<script src="barchart.js"></script>
<script src="map.js"></script>

<script>
    $( function() {
      $( "#datepicker" ).datepicker();
    } );

    $(document).ready(function(){
      $('input.timepicker').timepicker({});
    });

    function search() {
        depart = document.getElementById("depart_airport").value;
        depart_text = document.getElementById("depart_airport").options[document.getElementById('depart_airport').selectedIndex].text;
        arrive = document.getElementById("arrive_airport").value;        
        arrive_text = document.getElementById("arrive_airport").options[document.getElementById('arrive_airport').selectedIndex].text;       
        depart_date = $('#datepicker').val();
        min_connect_time = document.getElementById("min_connect_time").value;
        order_text = document.getElementById("order_by").options[document.getElementById('order_by').selectedIndex].text;
        console.log(`Order text = ${order_text}`)
        console.log("searching...");
        console.log(depart);
        console.log(arrive);
        console.log(depart_date)
        tripheader = document.getElementById("trip_header");
        tripheader.innerHTML = "Flying from " + depart_text + " to " + arrive_text + " on " + depart_date  + ", connecting through the following cities"; 
        showFlights(depart, arrive, depart_date, min_connect_time, order_text);       
    }

    function dateChanged() {
    }

    $(document).ready(function(){
      getDestinations();
    });


    function getDestinations() {
      depart = document.getElementById("depart_airport").value;        
      $.get( "http://localhost:3000/destinations?origin=" + depart, function( data ) {
        $( ".result" ).html( data );
        jsonObj = JSON.parse(data.items)
        var select = document.getElementById("arrive_airport");
        for (row of jsonObj) {
          var option = document.createElement('option');
          option.text = row[1] + " - " + row[0]          
          option.value = row[0];
          arrive_airport.options.add(option, undefined);
        }
      });
    }

    function showFlights(depart, arrive, date, connect_time, order) {
        url = "http://localhost:3000/flights?origin=" + depart + "&dest=" + arrive + "&date=" + date + "&connect_time=" + connect_time + "&order=" + order
        encodedUri = encodeURI(url);
        $.get(encodedUri, function( data ) {
          $( ".result" ).html( data );
          jsonObj = JSON.parse(data.items)
          top_results = document.getElementById("top_results").value;
          if (top_results.length == 0) {
            top_results = 8
          } else {
            top_results = parseInt(top_results)
          }
          flights = jsonObj.slice(0, top_results);
          console.log(flights)
          drawBarChart(flights);
          drawMap(flights, depart, arrive);
        });
    }

    function reorganize(){
      flights.sort((x, y) => d3.ascending(x['Itinerary Risk'], y['Itinerary Risk']))
      drawBarChart(flights);
      drawMap(flights);
    }
 

</script>
</head>

<body>
<div class="header">
    <h2>Flight Connections Risk Analyzer</h2>        
</div>
<br>
<table>
  <tr>
  <td><label for="depart_airport">Departing From:</label></td>
  <td>
    <select name="depart_airport" id="depart_airport">
    <option value="SAN">San Diego - SAN</option>
    </select>
  </td>
  <Td colspan=2>
    <label for="arrive_airport">Arriving To:</label>
    <select name="arrive_airport" id="arrive_airport"></select>
  </Td>
  </tr>
  <tr>
    <td>Departure Date:</td>
    <td><input type="text" id="datepicker" size="10" onchange="dateChanged()" value="8/5/2022"></td>
    <!--Td>Departure Time:</Td>
    <td><input type="text" id="timepicker" class="timepicker" size="10"-->
    <td>
    Minimum Connection Time (mins):&nbsp;<input type="text" id="min_connect_time" maxlength="3" size="5" value="45">
    </td>
  </tr>
  <tr>
    <td>Take-off from San Diego</td>
    <td class="slidecontainer">
      <input type="range" min="1" max="100" value="1" class="slider" id="myDepRange">
    </td>
    <td>Landing at Destination</td>
    <td class="slidecontainer">
      <input type="range" min="1" max="100" value="1" class="slider" id="myArrRange">
    </td>
    <td>Display Top Results: </td>
    <td><input type="text" id="top_results" maxlength="3" size="5" value="8"></td>
  </tr>
</table>
<button type="submit" onclick="search()">Search For Flights<i class="fa fa-search"></i></button>
<br>
<br>
<div>Order Results By:
<select name="order_by" id="order_by", onchange="reorganize()">
  <option value="Trip Duration">Duration</option>
  <option value="Itinerary Risk">Risk</option>
</select>
</div>
<br>
<h3 id="trip_header"></h3>
<div class="footer">
    <p>Georgia Tech CSE 6242  -  Spring 2023  -  Team 161</p>
  </div>
</body>
</html>